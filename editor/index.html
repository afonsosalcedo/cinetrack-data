<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineTrack Editor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }
    header {
      background: #16213e;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      border-bottom: 1px solid #0f3460;
    }
    header h1 { font-size: 1.5rem; color: #e94560; }
    select, input, button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 1px solid #0f3460;
      background: #16213e;
      color: #eee;
      font-size: 1rem;
    }
    select:focus, input:focus { outline: 2px solid #e94560; }
    button {
      background: #e94560;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #ff6b6b; }
    button.secondary { background: #0f3460; }
    button.secondary:hover { background: #1a1a2e; }

    /* Mode toggle */
    .mode-toggle {
      display: flex;
      background: #0f3460;
      border-radius: 6px;
      overflow: hidden;
    }
    .mode-toggle button {
      border-radius: 0;
      background: transparent;
      padding: 0.5rem 1rem;
      font-weight: 500;
    }
    .mode-toggle button.active {
      background: #e94560;
    }
    .mode-toggle button:hover:not(.active) {
      background: #16213e;
    }

    .container {
      display: grid;
      grid-template-columns: 350px 1fr;
      height: calc(100vh - 60px);
    }
    .container.nomination-mode {
      grid-template-columns: 1fr;
    }
    .sidebar {
      background: #16213e;
      border-right: 1px solid #0f3460;
      display: flex;
      flex-direction: column;
    }
    .search-box { padding: 1rem; }
    .search-box input { width: 100%; }
    .film-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .film-item {
      padding: 0.75rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 0.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .film-item:hover { background: #0f3460; }
    .film-item.selected { background: #e94560; }
    .film-item .title { font-weight: 500; }
    .film-item .badges { display: flex; gap: 0.25rem; }
    .badge {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      background: #0f3460;
    }
    .badge.nominated { background: #e94560; }
    .badge.shortlisted { background: #4a6fa5; }
    .editor {
      padding: 2rem;
      overflow-y: auto;
    }
    .editor h2 { margin-bottom: 1.5rem; color: #e94560; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #aaa;
    }
    .form-group input[type="text"],
    .form-group input[type="number"] {
      width: 100%;
      max-width: 400px;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.5rem;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #0f3460;
      border-radius: 4px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #e94560;
    }
    .section-title {
      font-size: 1.1rem;
      color: #e94560;
      margin: 2rem 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #0f3460;
    }
    .array-editor { margin-top: 0.5rem; }
    .array-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    .array-item input { flex: 1; max-width: 300px; }
    .array-item button { padding: 0.25rem 0.75rem; }
    .song-item {
      background: #0f3460;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    .song-item input { margin-bottom: 0.5rem; }
    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #0f3460;
    }
    .status {
      margin-left: auto;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .status.success { background: #2d6a4f; }
    .status.error { background: #9d0208; }
    .add-film-btn {
      margin: 1rem;
      width: calc(100% - 2rem);
    }
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      font-size: 1.2rem;
    }

    /* Nomination Mode Styles */
    .nomination-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    .nomination-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .nomination-header select {
      font-size: 1.1rem;
      padding: 0.75rem 1rem;
      min-width: 300px;
    }
    .nomination-header .nom-count {
      color: #aaa;
      font-size: 1rem;
    }
    .shortlisted-section, .nominated-section {
      margin-bottom: 2rem;
    }
    .shortlisted-section h3, .nominated-section h3 {
      color: #aaa;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 1rem;
    }
    .film-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .film-chip {
      padding: 0.6rem 1rem;
      background: #0f3460;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      border: 2px solid transparent;
    }
    .film-chip:hover {
      background: #16213e;
      border-color: #e94560;
    }
    .film-chip.nominated {
      background: #e94560;
      border-color: #e94560;
    }
    .film-chip.nominated:hover {
      background: #ff6b6b;
    }
    .nominated-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .nominated-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: #0f3460;
      border-radius: 6px;
    }
    .nominated-item .film-title {
      flex: 1;
    }
    .nominated-item .person-name {
      color: #e94560;
      font-weight: 600;
    }
    .nominated-item button {
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
    }
    .add-nomination-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .add-nomination-form input {
      flex: 1;
      min-width: 200px;
    }
    .add-nomination-form select {
      min-width: 250px;
    }
    .quick-add-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #0f3460;
    }
    .quick-add-section h4 {
      color: #aaa;
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }
    .save-float {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .category-nav {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .category-nav button {
      padding: 0.5rem 1rem;
    }
    .all-films-dropdown {
      position: relative;
    }
    .dropdown-search {
      width: 300px;
    }
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .dropdown-list.open {
      display: block;
    }
    .dropdown-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
    }
    .dropdown-item:hover {
      background: #0f3460;
    }
    .song-chips {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .song-chip {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: #0f3460;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .song-chip:hover {
      border-color: #e94560;
    }
    .song-chip.nominated {
      background: #e94560;
      border-color: #e94560;
    }
    .song-chip .song-title {
      font-weight: 600;
    }
    .song-chip .song-film {
      color: #aaa;
      font-size: 0.9rem;
    }
    .song-chip.nominated .song-film {
      color: rgba(255,255,255,0.8);
    }

    /* TMDB Lookup Mode Styles */
    .tmdb-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }
    .tmdb-header {
      margin-bottom: 2rem;
    }
    .tmdb-header h2 {
      color: #e94560;
      margin-bottom: 0.5rem;
    }
    .tmdb-header p {
      color: #aaa;
    }
    .tmdb-progress {
      background: #0f3460;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .tmdb-progress-bar {
      height: 8px;
      background: #16213e;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .tmdb-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      transition: width 0.3s;
    }
    .tmdb-current-film {
      background: #16213e;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .tmdb-current-film h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .tmdb-search-box {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tmdb-search-box input {
      flex: 1;
    }
    .tmdb-results {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .tmdb-result {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: #0f3460;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    .tmdb-result:hover {
      border-color: #e94560;
    }
    .tmdb-result img {
      width: 60px;
      height: 90px;
      object-fit: cover;
      border-radius: 4px;
      background: #16213e;
    }
    .tmdb-result-info {
      flex: 1;
    }
    .tmdb-result-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .tmdb-result-year {
      color: #e94560;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .tmdb-result-overview {
      font-size: 0.85rem;
      color: #aaa;
      line-height: 1.4;
    }
    .tmdb-result-id {
      font-size: 0.75rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .tmdb-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .tmdb-film-list {
      margin-top: 2rem;
    }
    .tmdb-film-list h4 {
      color: #aaa;
      margin-bottom: 1rem;
    }
    .tmdb-missing-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #0f3460;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    .tmdb-missing-item.current {
      background: #e94560;
    }
    .tmdb-missing-item.done {
      background: #2d6a4f;
    }
    .tmdb-no-poster {
      width: 60px;
      height: 90px;
      background: #16213e;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>CineTrack Editor</h1>
    <select id="yearSelect"></select>
    <div class="mode-toggle">
      <button id="filmModeBtn" class="active" onclick="setMode('film')">Film Mode</button>
      <button id="nomModeBtn" onclick="setMode('nomination')">Nomination Mode</button>
      <button id="tmdbModeBtn" onclick="setMode('tmdb')">Fix IDs</button>
    </div>
    <span id="statusMsg" class="status" style="display: none;"></span>
  </header>

  <div class="container" id="mainContainer">
    <aside class="sidebar" id="sidebar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search films...">
      </div>
      <div class="film-list" id="filmList"></div>
      <button class="add-film-btn" onclick="addNewFilm()">+ Add New Film</button>
    </aside>

    <main class="editor" id="editor">
      <div class="empty-state">Select a film to edit</div>
    </main>
  </div>

  <script>
    let films = [];
    let manifest = null;
    let selectedFilmId = null;
    let currentYear = '2026';
    let currentMode = 'film';
    let currentCategory = 'bestsupportingactor'; // First category announced

    // All nomination categories with their config (ordered by typical announcement order)
    const categories = {
      // --- FIRST CHUNK ---
      bestsupportingactor: { label: 'Best Supporting Actor', type: 'acting', shortlist: null },
      bestsupportingactress: { label: 'Best Supporting Actress', type: 'acting', shortlist: null },
      bestanimatedshortfilm: { label: 'Best Animated Short Film', type: 'boolean', shortlist: 'shortlistAnimatedShort' },
      bestliveactionshort: { label: 'Best Live Action Short Film', type: 'boolean', shortlist: 'shortlistLiveActionShort' },
      bestcostumedesign: { label: 'Best Costume Design', type: 'boolean', shortlist: null },
      bestmakeupandhairstyling: { label: 'Best Makeup & Hairstyling', type: 'boolean', shortlist: 'shortlistMakeupAndHairstyling' },
      bestoriginalscore: { label: 'Best Original Score', type: 'boolean', shortlist: 'shortlistOriginalScore' },
      bestoriginalsong: { label: 'Best Original Song', type: 'song', shortlist: 'shortlistOriginalSong' },
      bestsound: { label: 'Best Sound', type: 'boolean', shortlist: 'shortlistSound' },
      bestvisualeffects: { label: 'Best Visual Effects', type: 'boolean', shortlist: 'shortlistVisualEffects' },
      // --- SECOND CHUNK ---
      bestactor: { label: 'Best Actor', type: 'acting', shortlist: null },
      bestactress: { label: 'Best Actress', type: 'acting', shortlist: null },
      bestanimatedfeature: { label: 'Best Animated Feature', type: 'boolean', shortlist: null },
      bestcasting: { label: 'Best Casting', type: 'boolean', shortlist: 'shortlistCasting' },
      bestdirector: { label: 'Best Director', type: 'boolean', shortlist: null },
      bestdocumentaryfeature: { label: 'Best Documentary Feature', type: 'boolean', shortlist: 'shortlistDocumentaryFeature' },
      bestdocumentaryshort: { label: 'Best Documentary Short', type: 'boolean', shortlist: 'shortlistDocumentaryShort' },
      bestfilmediting: { label: 'Best Film Editing', type: 'boolean', shortlist: null },
      bestinternationalfeature: { label: 'Best International Feature', type: 'boolean', shortlist: 'shortlistInternationalFeature' },
      bestproductiondesign: { label: 'Best Production Design', type: 'boolean', shortlist: null },
      bestoriginalscreenplay: { label: 'Best Original Screenplay', type: 'boolean', shortlist: null },
      bestadaptedscreenplay: { label: 'Best Adapted Screenplay', type: 'boolean', shortlist: null },
      bestcinematography: { label: 'Best Cinematography', type: 'boolean', shortlist: 'shortlistCinematography' },
      bestpicture: { label: 'Best Picture', type: 'boolean', shortlist: null }
    };

    const categoryLabels = {};
    const shortlistLabels = {
      shortlistAnimatedShort: 'Animated Short',
      shortlistCasting: 'Casting',
      shortlistCinematography: 'Cinematography',
      shortlistDocumentaryFeature: 'Documentary Feature',
      shortlistDocumentaryShort: 'Documentary Short',
      shortlistInternationalFeature: 'International Feature',
      shortlistLiveActionShort: 'Live Action Short',
      shortlistMakeupAndHairstyling: 'Makeup & Hairstyling',
      shortlistOriginalScore: 'Original Score',
      shortlistOriginalSong: 'Original Song',
      shortlistSound: 'Sound',
      shortlistVisualEffects: 'Visual Effects'
    };

    // Build categoryLabels from categories
    Object.entries(categories).forEach(([key, val]) => {
      if (val.type === 'boolean') categoryLabels[key] = val.label;
    });

    async function init() {
      manifest = await fetch('/api/manifest').then(r => r.json());
      const yearSelect = document.getElementById('yearSelect');
      manifest.years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y.id;
        opt.textContent = `Oscars ${y.id}${y.nominationsAnnounced ? ' (Nominations)' : ' (Shortlist)'}`;
        yearSelect.appendChild(opt);
      });
      yearSelect.value = currentYear;
      yearSelect.onchange = () => loadYear(yearSelect.value);
      await loadYear(currentYear);
    }

    async function loadYear(year) {
      currentYear = year;
      films = await fetch(`/api/films/${year}`).then(r => r.json());
      selectedFilmId = null;
      if (currentMode === 'film') {
        renderFilmList();
        document.getElementById('editor').innerHTML = '<div class="empty-state">Select a film to edit</div>';
      } else {
        renderNominationMode();
      }
    }

    function setMode(mode) {
      currentMode = mode;
      document.getElementById('filmModeBtn').classList.toggle('active', mode === 'film');
      document.getElementById('nomModeBtn').classList.toggle('active', mode === 'nomination');
      document.getElementById('tmdbModeBtn').classList.toggle('active', mode === 'tmdb');

      const container = document.getElementById('mainContainer');
      const sidebar = document.getElementById('sidebar');

      if (mode === 'film') {
        container.classList.remove('nomination-mode');
        sidebar.style.display = 'flex';
        renderFilmList();
        document.getElementById('editor').innerHTML = '<div class="empty-state">Select a film to edit</div>';
      } else if (mode === 'nomination') {
        container.classList.add('nomination-mode');
        sidebar.style.display = 'none';
        renderNominationMode();
      } else if (mode === 'tmdb') {
        container.classList.add('nomination-mode');
        sidebar.style.display = 'none';
        renderTmdbMode();
      }
    }

    // ============ FILM MODE FUNCTIONS ============

    function renderFilmList() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = films
        .filter(f => f.title.toLowerCase().includes(search))
        .sort((a, b) => a.title.localeCompare(b.title));
      const list = document.getElementById('filmList');
      list.innerHTML = filtered.map(f => {
        const hasNominations = Object.keys(categoryLabels).some(k => f[k]) ||
          (f.bestactor && f.bestactor.length > 0) ||
          (f.bestactress && f.bestactress.length > 0) ||
          (f.bestsupportingactor && f.bestsupportingactor.length > 0) ||
          (f.bestsupportingactress && f.bestsupportingactress.length > 0);
        const hasShortlist = Object.keys(shortlistLabels).some(k => f[k]);
        const badges = [];
        if (hasNominations) badges.push('<span class="badge nominated">NOM</span>');
        if (hasShortlist) badges.push('<span class="badge shortlisted">SL</span>');
        return `
          <div class="film-item ${f.id === selectedFilmId ? 'selected' : ''}" onclick="selectFilm('${f.id}')">
            <span class="title">${f.title}</span>
            <span class="badges">${badges.join('')}</span>
          </div>
        `;
      }).join('');
    }

    function selectFilm(id) {
      selectedFilmId = id;
      renderFilmList();
      renderEditor();
    }

    function renderEditor() {
      const film = films.find(f => f.id === selectedFilmId);
      if (!film) return;

      const editor = document.getElementById('editor');
      editor.innerHTML = `
        <h2>${film.title}</h2>

        <div class="form-group">
          <label>Title</label>
          <input type="text" value="${film.title}" onchange="updateField('title', this.value)">
        </div>

        <div class="form-group">
          <label>TMDB ID</label>
          <input type="number" value="${film.tmdbId || ''}" onchange="updateField('tmdbId', parseInt(this.value) || null)">
        </div>

        <div class="section-title">Nominations</div>
        <div class="checkbox-grid">
          ${Object.entries(categoryLabels).map(([key, label]) => `
            <label class="checkbox-item">
              <input type="checkbox" ${film[key] ? 'checked' : ''} onchange="updateField('${key}', this.checked)">
              ${label}
            </label>
          `).join('')}
        </div>

        <div class="section-title">Shortlisted</div>
        <div class="checkbox-grid">
          ${Object.entries(shortlistLabels).map(([key, label]) => `
            <label class="checkbox-item">
              <input type="checkbox" ${film[key] ? 'checked' : ''} onchange="updateField('${key}', this.checked)">
              ${label}
            </label>
          `).join('')}
        </div>

        <div class="section-title">Best Actor</div>
        <div class="array-editor" id="bestactor-editor">
          ${renderArrayEditor('bestactor', film.bestactor || [])}
        </div>

        <div class="section-title">Best Actress</div>
        <div class="array-editor" id="bestactress-editor">
          ${renderArrayEditor('bestactress', film.bestactress || [])}
        </div>

        <div class="section-title">Best Supporting Actor</div>
        <div class="array-editor" id="bestsupportingactor-editor">
          ${renderArrayEditor('bestsupportingactor', film.bestsupportingactor || [])}
        </div>

        <div class="section-title">Best Supporting Actress</div>
        <div class="array-editor" id="bestsupportingactress-editor">
          ${renderArrayEditor('bestsupportingactress', film.bestsupportingactress || [])}
        </div>

        <div class="section-title">Best Original Song</div>
        <div id="songs-editor">
          ${renderSongsEditor(film.bestoriginalsong || [])}
        </div>

        <div class="actions">
          <button onclick="saveFilms()">Save All Changes</button>
          <button class="secondary" onclick="deleteFilm()">Delete Film</button>
        </div>
      `;
    }

    function renderArrayEditor(field, items) {
      return `
        ${items.map((item, i) => `
          <div class="array-item">
            <input type="text" value="${item}" onchange="updateArrayItem('${field}', ${i}, this.value)">
            <button class="secondary" onclick="removeArrayItem('${field}', ${i})">Remove</button>
          </div>
        `).join('')}
        <button class="secondary" onclick="addArrayItem('${field}')">+ Add</button>
      `;
    }

    function renderSongsEditor(songs) {
      return `
        ${songs.map((song, i) => `
          <div class="song-item">
            <input type="text" value="${song.songTitle}" placeholder="Song title"
                   onchange="updateSong(${i}, 'songTitle', this.value)" style="width: 100%;">
            <input type="text" value="${(song.songwriters || []).join(', ')}" placeholder="Songwriters (comma-separated)"
                   onchange="updateSongwriters(${i}, this.value)" style="width: 100%;">
            <button class="secondary" onclick="removeSong(${i})">Remove Song</button>
          </div>
        `).join('')}
        <button class="secondary" onclick="addSong()">+ Add Song</button>
      `;
    }

    function updateField(field, value) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film) {
        film[field] = value;
        if (field === 'title') renderFilmList();
      }
    }

    function updateArrayItem(field, index, value) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film && film[field]) {
        film[field][index] = value;
      }
    }

    function addArrayItem(field) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film) {
        if (!film[field]) film[field] = [];
        film[field].push('');
        renderEditor();
      }
    }

    function removeArrayItem(field, index) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film && film[field]) {
        film[field].splice(index, 1);
        renderEditor();
      }
    }

    function updateSong(index, field, value) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film && film.bestoriginalsong && film.bestoriginalsong[index]) {
        film.bestoriginalsong[index][field] = value;
      }
    }

    function updateSongwriters(index, value) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film && film.bestoriginalsong && film.bestoriginalsong[index]) {
        film.bestoriginalsong[index].songwriters = value.split(',').map(s => s.trim()).filter(s => s);
      }
    }

    function addSong() {
      const film = films.find(f => f.id === selectedFilmId);
      if (film) {
        if (!film.bestoriginalsong) film.bestoriginalsong = [];
        film.bestoriginalsong.push({ songTitle: '', songwriters: [] });
        renderEditor();
      }
    }

    function removeSong(index) {
      const film = films.find(f => f.id === selectedFilmId);
      if (film && film.bestoriginalsong) {
        film.bestoriginalsong.splice(index, 1);
        renderEditor();
      }
    }

    function addNewFilm(prefillTitle = null) {
      const title = prefillTitle || prompt('Enter film title:');
      if (!title) return null;

      const maxId = Math.max(0, ...films.map(f => {
        const match = f.id.match(/(\d+)$/);
        return match ? parseInt(match[1]) : 0;
      }));

      const newFilm = {
        id: `00000001-0000-0000-0000-${String(maxId + 1).padStart(12, '0')}`,
        title: title,
        runtime: 0,
        watched: false,
        releaseDate: '',
        director: '',
        cast: [],
        description: '',
        imageURL: '',
        rating: 0,
        bestpicture: false,
        bestdirector: false,
        bestoriginalscreenplay: false,
        bestadaptedscreenplay: false,
        bestanimatedfeature: false,
        bestanimatedshortfilm: false,
        bestinternationalfeature: false,
        bestdocumentaryfeature: false,
        bestdocumentaryshort: false,
        bestcinematography: false,
        bestfilmediting: false,
        bestproductiondesign: false,
        bestcostumedesign: false,
        bestmakeupandhairstyling: false,
        bestsound: false,
        bestvisualeffects: false,
        bestoriginalscore: false,
        bestliveactionshort: false,
        bestcasting: false,
        shortlistAnimatedShort: false,
        shortlistCasting: false,
        shortlistCinematography: false,
        shortlistDocumentaryFeature: false,
        shortlistDocumentaryShort: false,
        shortlistInternationalFeature: false,
        shortlistLiveActionShort: false,
        shortlistMakeupAndHairstyling: false,
        shortlistOriginalScore: false,
        shortlistOriginalSong: false,
        shortlistSound: false,
        shortlistVisualEffects: false,
        bestactor: [],
        bestactress: [],
        bestsupportingactor: [],
        bestsupportingactress: [],
        bestoriginalsong: []
      };

      films.push(newFilm);

      if (currentMode === 'film') {
        selectedFilmId = newFilm.id;
        renderFilmList();
        renderEditor();
      }

      return newFilm;
    }

    function deleteFilm() {
      if (!selectedFilmId) return;
      const film = films.find(f => f.id === selectedFilmId);
      if (!confirm(`Delete "${film.title}"?`)) return;
      films = films.filter(f => f.id !== selectedFilmId);
      selectedFilmId = null;
      renderFilmList();
      document.getElementById('editor').innerHTML = '<div class="empty-state">Select a film to edit</div>';
    }

    // ============ NOMINATION MODE FUNCTIONS ============

    function renderNominationMode() {
      const editor = document.getElementById('editor');
      const cat = categories[currentCategory];

      editor.innerHTML = `
        <div class="nomination-container">
          <div class="nomination-header">
            <select id="categorySelect" onchange="changeCategory(this.value)">
              ${Object.entries(categories).map(([key, val]) => `
                <option value="${key}" ${key === currentCategory ? 'selected' : ''}>${val.label}</option>
              `).join('')}
            </select>
            <span class="nom-count">${getNominationCount(currentCategory)} nominated</span>
          </div>

          ${renderCategoryUI(currentCategory)}

          <div class="category-nav">
            <button class="secondary" onclick="prevCategory()">Previous Category</button>
            <button class="secondary" onclick="nextCategory()">Next Category</button>
          </div>
        </div>
        <button class="save-float" onclick="saveFilms()">Save All Changes</button>
      `;
    }

    function changeCategory(cat) {
      currentCategory = cat;
      renderNominationMode();
    }

    function prevCategory() {
      const keys = Object.keys(categories);
      const idx = keys.indexOf(currentCategory);
      currentCategory = keys[(idx - 1 + keys.length) % keys.length];
      renderNominationMode();
    }

    function nextCategory() {
      const keys = Object.keys(categories);
      const idx = keys.indexOf(currentCategory);
      currentCategory = keys[(idx + 1) % keys.length];
      renderNominationMode();
    }

    function getNominationCount(cat) {
      const config = categories[cat];
      if (config.type === 'boolean') {
        return films.filter(f => f[cat]).length;
      } else if (config.type === 'acting') {
        return films.reduce((sum, f) => sum + (f[cat] ? f[cat].length : 0), 0);
      } else if (config.type === 'song') {
        // Count songs that are nominated (film has the nomination marked)
        return films.reduce((sum, f) => {
          if (f.bestoriginalsong && f.bestoriginalsong.length > 0) {
            // Each song in the array counts as a nomination
            return sum + f.bestoriginalsong.filter(s => s.nominated !== false).length;
          }
          return sum;
        }, 0);
      }
      return 0;
    }

    function renderCategoryUI(cat) {
      const config = categories[cat];

      if (config.type === 'boolean') {
        return renderBooleanCategory(cat, config);
      } else if (config.type === 'acting') {
        return renderActingCategory(cat, config);
      } else if (config.type === 'song') {
        return renderSongCategory(cat, config);
      }
      return '';
    }

    function renderBooleanCategory(cat, config) {
      const shortlistField = config.shortlist;
      const shortlistedFilms = shortlistField
        ? films.filter(f => f[shortlistField]).sort((a, b) => a.title.localeCompare(b.title))
        : [];
      const nominatedFilms = films.filter(f => f[cat]).sort((a, b) => a.title.localeCompare(b.title));
      const allFilmsSorted = films.slice().sort((a, b) => a.title.localeCompare(b.title));

      return `
        ${shortlistedFilms.length > 0 ? `
          <div class="shortlisted-section">
            <h3>Shortlisted Films (click to nominate)</h3>
            <div class="film-chips">
              ${shortlistedFilms.map(f => `
                <div class="film-chip ${f[cat] ? 'nominated' : ''}" onclick="toggleBooleanNomination('${f.id}', '${cat}')">
                  ${f.title}
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <div class="nominated-section">
          <h3>Nominated (${nominatedFilms.length})</h3>
          ${nominatedFilms.length > 0 ? `
            <div class="nominated-list">
              ${nominatedFilms.map(f => `
                <div class="nominated-item">
                  <span class="film-title">${f.title}</span>
                  <button class="secondary" onclick="toggleBooleanNomination('${f.id}', '${cat}')">Remove</button>
                </div>
              `).join('')}
            </div>
          ` : '<p style="color: #666;">No nominations yet</p>'}
        </div>

        <div class="quick-add-section">
          <h4>Add from all films or create new:</h4>
          <div class="add-nomination-form">
            <div class="all-films-dropdown">
              <input type="text" class="dropdown-search" id="filmSearch-${cat}"
                     placeholder="Search all films..."
                     oninput="filterFilmDropdown('${cat}')"
                     onfocus="openFilmDropdown('${cat}')">
              <div class="dropdown-list" id="filmDropdown-${cat}">
                ${allFilmsSorted.filter(f => !f[cat]).map(f => `
                  <div class="dropdown-item" onclick="toggleBooleanNomination('${f.id}', '${cat}'); closeFilmDropdown('${cat}');">
                    ${f.title}
                  </div>
                `).join('')}
              </div>
            </div>
            <button onclick="addNewFilmAndNominate('${cat}')">+ New Film</button>
          </div>
        </div>
      `;
    }

    function renderActingCategory(cat, config) {
      const nominations = [];
      films.forEach(f => {
        if (f[cat] && f[cat].length > 0) {
          f[cat].forEach(name => {
            nominations.push({ film: f, name: name });
          });
        }
      });
      nominations.sort((a, b) => a.name.localeCompare(b.name));

      const allFilmsSorted = films.slice().sort((a, b) => a.title.localeCompare(b.title));

      return `
        <div class="nominated-section">
          <h3>Nominated (${nominations.length})</h3>
          ${nominations.length > 0 ? `
            <div class="nominated-list">
              ${nominations.map(n => `
                <div class="nominated-item">
                  <span class="person-name">${n.name}</span>
                  <span class="film-title">- ${n.film.title}</span>
                  <button class="secondary" onclick="removeActingNomination('${n.film.id}', '${cat}', '${n.name.replace(/'/g, "\\'")}')">Remove</button>
                </div>
              `).join('')}
            </div>
          ` : '<p style="color: #666;">No nominations yet</p>'}
        </div>

        <div class="quick-add-section">
          <h4>Add nomination:</h4>
          <div class="add-nomination-form">
            <input type="text" id="actorName-${cat}" placeholder="Actor/Actress name">
            <select id="actorFilm-${cat}">
              <option value="">Select film...</option>
              ${allFilmsSorted.map(f => `<option value="${f.id}">${f.title}</option>`).join('')}
            </select>
            <button onclick="addActingNomination('${cat}')">+ Add</button>
          </div>
          <div class="add-nomination-form" style="margin-top: 0.5rem;">
            <input type="text" id="newFilmActorName-${cat}" placeholder="Actor name for new film">
            <input type="text" id="newFilmTitle-${cat}" placeholder="New film title">
            <button onclick="addActingNominationNewFilm('${cat}')">+ Add with New Film</button>
          </div>
        </div>
      `;
    }

    function renderSongCategory(cat, config) {
      const shortlistField = config.shortlist;

      // Get all songs from shortlisted films
      const shortlistedSongs = [];
      const nominatedSongs = [];

      films.forEach(f => {
        if (f.bestoriginalsong && f.bestoriginalsong.length > 0) {
          f.bestoriginalsong.forEach((song, idx) => {
            const songData = { film: f, song: song, index: idx };
            if (song.nominated) {
              nominatedSongs.push(songData);
            } else if (f[shortlistField]) {
              shortlistedSongs.push(songData);
            }
          });
        }
      });

      shortlistedSongs.sort((a, b) => a.song.songTitle.localeCompare(b.song.songTitle));
      nominatedSongs.sort((a, b) => a.song.songTitle.localeCompare(b.song.songTitle));

      const allFilmsSorted = films.slice().sort((a, b) => a.title.localeCompare(b.title));

      return `
        ${shortlistedSongs.length > 0 ? `
          <div class="shortlisted-section">
            <h3>Shortlisted Songs (click to nominate)</h3>
            <div class="song-chips">
              ${shortlistedSongs.map(s => `
                <div class="song-chip" onclick="toggleSongNomination('${s.film.id}', ${s.index})">
                  <span class="song-title">"${s.song.songTitle}"</span>
                  <span class="song-film">from ${s.film.title}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <div class="nominated-section">
          <h3>Nominated (${nominatedSongs.length})</h3>
          ${nominatedSongs.length > 0 ? `
            <div class="song-chips">
              ${nominatedSongs.map(s => `
                <div class="song-chip nominated" onclick="toggleSongNomination('${s.film.id}', ${s.index})">
                  <span class="song-title">"${s.song.songTitle}"</span>
                  <span class="song-film">from ${s.film.title}</span>
                </div>
              `).join('')}
            </div>
          ` : '<p style="color: #666;">No nominations yet</p>'}
        </div>

        <div class="quick-add-section">
          <h4>Add new song nomination:</h4>
          <div class="add-nomination-form">
            <input type="text" id="newSongTitle" placeholder="Song title">
            <select id="newSongFilm">
              <option value="">Select film...</option>
              ${allFilmsSorted.map(f => `<option value="${f.id}">${f.title}</option>`).join('')}
            </select>
            <button onclick="addSongNomination()">+ Add Song</button>
          </div>
          <div class="add-nomination-form" style="margin-top: 0.5rem;">
            <input type="text" id="newSongTitleNewFilm" placeholder="Song title">
            <input type="text" id="newSongFilmTitle" placeholder="New film title">
            <button onclick="addSongNominationNewFilm()">+ Add with New Film</button>
          </div>
        </div>
      `;
    }

    // Nomination mode actions
    function toggleBooleanNomination(filmId, cat) {
      const film = films.find(f => f.id === filmId);
      if (film) {
        film[cat] = !film[cat];
        renderNominationMode();
      }
    }

    function addNewFilmAndNominate(cat) {
      const title = prompt('Enter new film title:');
      if (!title) return;

      const newFilm = addNewFilm(title);
      if (newFilm) {
        newFilm[cat] = true;
        renderNominationMode();
      }
    }

    function addActingNomination(cat) {
      const name = document.getElementById(`actorName-${cat}`).value.trim();
      const filmId = document.getElementById(`actorFilm-${cat}`).value;

      if (!name || !filmId) {
        alert('Please enter actor name and select a film');
        return;
      }

      const film = films.find(f => f.id === filmId);
      if (film) {
        if (!film[cat]) film[cat] = [];
        if (!film[cat].includes(name)) {
          film[cat].push(name);
        }
        renderNominationMode();
      }
    }

    function addActingNominationNewFilm(cat) {
      const name = document.getElementById(`newFilmActorName-${cat}`).value.trim();
      const filmTitle = document.getElementById(`newFilmTitle-${cat}`).value.trim();

      if (!name || !filmTitle) {
        alert('Please enter both actor name and film title');
        return;
      }

      const newFilm = addNewFilm(filmTitle);
      if (newFilm) {
        newFilm[cat] = [name];
        renderNominationMode();
      }
    }

    function removeActingNomination(filmId, cat, name) {
      const film = films.find(f => f.id === filmId);
      if (film && film[cat]) {
        film[cat] = film[cat].filter(n => n !== name);
        renderNominationMode();
      }
    }

    function toggleSongNomination(filmId, songIndex) {
      const film = films.find(f => f.id === filmId);
      if (film && film.bestoriginalsong && film.bestoriginalsong[songIndex]) {
        film.bestoriginalsong[songIndex].nominated = !film.bestoriginalsong[songIndex].nominated;
        renderNominationMode();
      }
    }

    function addSongNomination() {
      const songTitle = document.getElementById('newSongTitle').value.trim();
      const filmId = document.getElementById('newSongFilm').value;

      if (!songTitle || !filmId) {
        alert('Please enter song title and select a film');
        return;
      }

      const film = films.find(f => f.id === filmId);
      if (film) {
        if (!film.bestoriginalsong) film.bestoriginalsong = [];
        film.bestoriginalsong.push({ songTitle: songTitle, songwriters: [], nominated: true });
        renderNominationMode();
      }
    }

    function addSongNominationNewFilm() {
      const songTitle = document.getElementById('newSongTitleNewFilm').value.trim();
      const filmTitle = document.getElementById('newSongFilmTitle').value.trim();

      if (!songTitle || !filmTitle) {
        alert('Please enter both song title and film title');
        return;
      }

      const newFilm = addNewFilm(filmTitle);
      if (newFilm) {
        newFilm.bestoriginalsong = [{ songTitle: songTitle, songwriters: [], nominated: true }];
        renderNominationMode();
      }
    }

    // Dropdown helpers
    function openFilmDropdown(cat) {
      document.getElementById(`filmDropdown-${cat}`).classList.add('open');
    }

    function closeFilmDropdown(cat) {
      document.getElementById(`filmDropdown-${cat}`).classList.remove('open');
    }

    function filterFilmDropdown(cat) {
      const search = document.getElementById(`filmSearch-${cat}`).value.toLowerCase();
      const dropdown = document.getElementById(`filmDropdown-${cat}`);
      const allFilmsSorted = films.slice().sort((a, b) => a.title.localeCompare(b.title));

      dropdown.innerHTML = allFilmsSorted
        .filter(f => !f[cat] && f.title.toLowerCase().includes(search))
        .map(f => `
          <div class="dropdown-item" onclick="toggleBooleanNomination('${f.id}', '${cat}'); closeFilmDropdown('${cat}');">
            ${f.title}
          </div>
        `).join('');

      dropdown.classList.add('open');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.all-films-dropdown')) {
        document.querySelectorAll('.dropdown-list').forEach(d => d.classList.remove('open'));
      }
    });

    // ============ TMDB LOOKUP MODE FUNCTIONS ============

    let tmdbCurrentIndex = 0;
    let tmdbSearchResults = [];
    let tmdbFixedIds = new Set(); // Track which films we've fixed in this session

    function getFilmsMissingTmdbId() {
      return films.filter(f => !f.tmdbId).sort((a, b) => a.title.localeCompare(b.title));
    }

    function renderTmdbMode() {
      const editor = document.getElementById('editor');
      const missingFilms = getFilmsMissingTmdbId();
      const totalFilms = films.length;
      const fixedCount = totalFilms - missingFilms.length;

      if (missingFilms.length === 0) {
        editor.innerHTML = `
          <div class="tmdb-container">
            <div class="tmdb-header">
              <h2>All Films Have TMDB IDs!</h2>
              <p>Every film in the database has a valid TMDB ID. No action needed.</p>
            </div>
            <div class="tmdb-progress">
              <div><strong>${fixedCount}</strong> of ${totalFilms} films have TMDB IDs (100%)</div>
              <div class="tmdb-progress-bar">
                <div class="tmdb-progress-fill" style="width: 100%"></div>
              </div>
            </div>
          </div>
        `;
        return;
      }

      const currentFilm = missingFilms[tmdbCurrentIndex] || missingFilms[0];
      tmdbCurrentIndex = Math.min(tmdbCurrentIndex, missingFilms.length - 1);

      const progressPercent = (fixedCount / totalFilms * 100).toFixed(1);

      editor.innerHTML = `
        <div class="tmdb-container">
          <div class="tmdb-header">
            <h2>Fix Missing TMDB IDs</h2>
            <p>Search TMDB and assign the correct movie ID to each film.</p>
          </div>

          <div class="tmdb-progress">
            <div><strong>${fixedCount}</strong> of ${totalFilms} films have TMDB IDs (${progressPercent}%) &mdash; <strong>${missingFilms.length}</strong> remaining</div>
            <div class="tmdb-progress-bar">
              <div class="tmdb-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
          </div>

          <div class="tmdb-current-film">
            <h3>${currentFilm.title}</h3>
            <div class="tmdb-search-box">
              <input type="text" id="tmdbSearchInput" value="${currentFilm.title}"
                     onkeypress="if(event.key==='Enter') searchTmdb()">
              <button onclick="searchTmdb()">Search TMDB</button>
            </div>
            <div id="tmdbResults" class="tmdb-results">
              <p style="color: #666;">Click "Search TMDB" to find matching movies</p>
            </div>
            <div class="tmdb-actions">
              <button class="secondary" onclick="skipTmdbFilm()">Skip This Film</button>
              <button class="secondary" onclick="prevTmdbFilm()">Previous</button>
              <button class="secondary" onclick="nextTmdbFilm()">Next</button>
            </div>
          </div>

          <div class="tmdb-film-list">
            <h4>Films Missing TMDB ID (${missingFilms.length})</h4>
            <div style="max-height: 300px; overflow-y: auto;">
              ${missingFilms.map((f, i) => `
                <div class="tmdb-missing-item ${i === tmdbCurrentIndex ? 'current' : ''} ${tmdbFixedIds.has(f.id) ? 'done' : ''}"
                     onclick="jumpToTmdbFilm(${i})">
                  <span>${f.title}</span>
                  ${tmdbFixedIds.has(f.id) ? '<span style="color: #8f8;">Fixed (unsaved)</span>' : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
        <button class="save-float" onclick="saveFilms()">Save All Changes</button>
      `;

      // Auto-search when rendering
      searchTmdb();
    }

    async function searchTmdb() {
      const query = document.getElementById('tmdbSearchInput').value.trim();
      if (!query) return;

      const resultsDiv = document.getElementById('tmdbResults');
      resultsDiv.innerHTML = '<p style="color: #aaa;">Searching...</p>';

      try {
        const res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        tmdbSearchResults = data.results || [];

        if (tmdbSearchResults.length === 0) {
          resultsDiv.innerHTML = '<p style="color: #e94560;">No results found. Try a different search term.</p>';
          return;
        }

        resultsDiv.innerHTML = tmdbSearchResults.map((movie, i) => `
          <div class="tmdb-result" onclick="applyTmdbId(${movie.id})">
            ${movie.poster
              ? `<img src="${movie.poster}" alt="${movie.title}">`
              : `<div class="tmdb-no-poster">No Poster</div>`}
            <div class="tmdb-result-info">
              <div class="tmdb-result-title">${movie.title}</div>
              <div class="tmdb-result-year">${movie.year} &middot; ${movie.director}</div>
              <div class="tmdb-result-overview">${movie.overview}</div>
              <div class="tmdb-result-id">TMDB ID: ${movie.id}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        resultsDiv.innerHTML = `<p style="color: #e94560;">Error: ${e.message}</p>`;
      }
    }

    function applyTmdbId(tmdbId) {
      const missingFilms = getFilmsMissingTmdbId();
      const currentFilm = missingFilms[tmdbCurrentIndex];

      if (currentFilm) {
        // Find and update the film in the main films array
        const filmIndex = films.findIndex(f => f.id === currentFilm.id);
        if (filmIndex >= 0) {
          films[filmIndex].tmdbId = tmdbId;
          tmdbFixedIds.add(currentFilm.id);
          showStatus(`Set TMDB ID ${tmdbId} for "${currentFilm.title}"`, 'success');

          // Move to next film
          nextTmdbFilm();
        }
      }
    }

    function skipTmdbFilm() {
      nextTmdbFilm();
    }

    function prevTmdbFilm() {
      const missingFilms = getFilmsMissingTmdbId();
      if (tmdbCurrentIndex > 0) {
        tmdbCurrentIndex--;
      } else {
        tmdbCurrentIndex = missingFilms.length - 1;
      }
      renderTmdbMode();
    }

    function nextTmdbFilm() {
      const missingFilms = getFilmsMissingTmdbId();
      if (missingFilms.length === 0) {
        renderTmdbMode();
        return;
      }
      if (tmdbCurrentIndex < missingFilms.length - 1) {
        tmdbCurrentIndex++;
      } else {
        tmdbCurrentIndex = 0;
      }
      renderTmdbMode();
    }

    function jumpToTmdbFilm(index) {
      tmdbCurrentIndex = index;
      renderTmdbMode();
    }

    // ============ SHARED FUNCTIONS ============

    async function saveFilms() {
      try {
        // Prompt for changelog
        const changelog = prompt('Changelog (what changed?):', '');
        if (changelog === null) {
          // User cancelled
          return;
        }

        // Sort films alphabetically before saving
        films.sort((a, b) => a.title.localeCompare(b.title));

        const res = await fetch(`/api/films/${currentYear}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ films, changelog: changelog || null })
        });
        const data = await res.json();
        if (data.success) {
          showStatus(`Saved! Version: ${data.version}`, 'success');
          if (currentMode === 'film') {
            renderFilmList();
          }
        } else {
          showStatus('Error saving: ' + data.error, 'error');
        }
      } catch (e) {
        showStatus('Error: ' + e.message, 'error');
      }
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = 'status ' + type;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    document.getElementById('searchInput').oninput = renderFilmList;

    init();
  </script>
</body>
</html>
